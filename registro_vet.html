<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ativar Pet Pass Vet</title>
  <style>
    body { font-family: 'Poppins', sans-serif; padding: 20px; background: #f2f4f8; margin: 0; }
    form { background: #fff; padding: 25px; border-radius: 10px; max-width: 700px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; color: #333; }
    h2 { font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
    input, textarea, select { width: 100%; padding: 12px; margin-bottom: 18px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { width: 100%; background-color: #007bff; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; }
    .status-message { text-align: center; font-weight: bold; margin-top: 20px; padding: 10px; border-radius: 5px; }
    .status-success { background-color: #d4edda; color: #155724; }
    .status-error { background-color: #f8d7da; color: #721c24; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <header style="text-align:center; margin-bottom:20px;">
    <img src="https://raw.githubusercontent.com/petpassvet/petpassvetv2/main/logo_petpass_vet.png" alt="Pet Pass Vet Logo" style="max-width:160px;" />
  </header>
  
  <form id="petpassVetForm">
    <h1>Ativa√ß√£o de Plaquinha Pet Pass Vet</h1>
    <label for="id_pet">N√∫mero de S√©rie (ex: PPV-12345):</label>
    <input type="text" id="id_pet" name="id_pet" required pattern="PPV-\d{5}" title="O formato deve ser PPV- seguido por 5 n√∫meros."/>
    
    <h2>üêæ Dados do Pet</h2>
    <label for="url_foto">Foto do Pet:</label>
    <input type="file" id="foto_pet_input" accept="image/*" required />
    <input type="hidden" name="foto_pet" id="foto_pet_base64">
    
    <label for="nome_pet">Nome:</label>
    <input type="text" name="nome_pet" required />
    <label for="especie_pet">Esp√©cie:</label><input type="text" name="especie_pet" required />
    <label for="raca_pet">Ra√ßa:</label><input type="text" name="raca_pet" />
    <label for="sexo_pet">Sexo:</label><select name="sexo_pet"><option value="Macho">Macho</option><option value="F√™mea">F√™mea</option></select>
    <label for="cor_pet">Cor:</label><input type="text" name="cor_pet" />
    <label for="idade_pet">Idade:</label><input type="text" name="idade_pet" />
    <label for="peso_pet">Peso (kg):</label><input type="text" name="peso_pet" />
    <label for="alergias_intolerancias">Alergias ou Intoler√¢ncias:</label><textarea name="alergias_intolerancias"></textarea>
    <label for="observacoes_gerais">Observa√ß√µes Gerais:</label><textarea name="observacoes_gerais"></textarea>

    <h2>üë§ Dados do Tutor</h2>
    <label for="nome_tutor">Nome:</label><input type="text" name="nome_tutor" required />
    <label for="telefone_tutor">Telefone:</label><input type="tel" name="telefone_tutor" required />
    <label for="email_tutor">Email:</label><input type="email" name="email_tutor" />
    <label for="localizacao_tutor">Localiza√ß√£o:</label><input type="text" name="localizacao_tutor" />

    <h2>üè• Cl√≠nica e Veterin√°rio</h2>
    <label for="nome_veterinario">Nome do Veterin√°rio:</label><input type="text" name="nome_veterinario" />
    <label for="nome_clinica">Nome da Cl√≠nica:</label><input type="text" name="nome_clinica" />
    <label for="email_clinica">Email da Cl√≠nica:</label><input type="email" name="email_clinica" />
    
    <h2>ü©∫ Hist√≥rico Inicial</h2>
    <label for="data_ultima_visita">Data do Atendimento:</label><input type="date" name="data_ultima_visita" />
    <label for="tipo_atendimento">Tipo de Atendimento:</label><input type="text" name="tipo_atendimento" />
    <label for="procedimentos_realizados">Procedimentos Realizados:</label><textarea name="procedimentos_realizados"></textarea>
    <label for="vacinas_aplicadas">Vacinas Aplicadas:</label><textarea name="vacinas_aplicadas"></textarea>

    <h2>üóìÔ∏è Pr√≥xima Visita</h2>
    <label for="data_proxima_visita">Data da Pr√≥xima Visita:</label><input type="date" name="data_proxima_visita" />
    <label for="obs_proxima_visita">Observa√ß√µes da Pr√≥xima Visita:</label><textarea name="obs_proxima_visita"></textarea>
    
    <button type="submit" id="submitButton">Ativar Plaquinha</button>
    <div id="statusMessage" class="status-message"></div>
  </form>

  <script>
    const form = document.getElementById('petpassVetForm');
    const statusMessage = document.getElementById('statusMessage');
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwOaTxOCYlrZ0gw-37zK6WwF21AIeTuZZ69ufi2C5Io4ht-lTrXQf7yc5CHZt1T4QKpYg/exec"; // Aseg√∫rate que esta URL es la √∫ltima

    form.addEventListener('submit', e => {
      e.preventDefault();
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = true;
      statusMessage.className = 'status-message';
      statusMessage.textContent = 'Enviando dados, por favor aguarde...';
      
      const file = document.getElementById('foto_pet_input').files[0];
      if (!file) {
        statusMessage.textContent = 'Erro: Por favor, selecione uma foto.';
        statusMessage.className = 'status-message status-error';
        submitButton.disabled = false;
        return;
      }
      
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = event => {
        document.getElementById('foto_pet_base64').value = event.target.result;
        
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        payload.action = "registerVet";

        // ========= INICIO DE LA CORRECCI√ìN DEFINITIVA =========
        fetch(SCRIPT_URL, {
          method: 'POST',
          // ELIMINAMOS CABECERAS Y MODO. DEJAMOS QUE EL NAVEGADOR MANEJE CORS.
          // ENVIAMOS EL BODY COMO TEXTO PLANO.
          body: JSON.stringify(payload),
        })
        .then(res => {
          // Primero, verificamos si la respuesta es OK.
          if (!res.ok) {
            // Si hay un error de red o de servidor (500, etc.), lanzamos un error.
            throw new Error(`Erro de rede: ${res.statusText}`);
          }
          return res.json(); // Si est√° ok, intentamos parsear como JSON.
        })
        .then(data => {
          if (data.result === 'success') {
            statusMessage.textContent = `Plaquinha ${data.id} ativada com sucesso!`;
            statusMessage.className = 'status-message status-success';
            form.reset();
          } else {
            // Si el JSON tiene un mensaje de error del script, lo mostramos.
            throw new Error(data.message || 'Ocorreu um erro no servidor.');
          }
        })
        .catch(error => {
          // Capturamos cualquier error, ya sea de red o del script.
          statusMessage.textContent = `Erro: ${error.message}`;
          statusMessage.className = 'status-message status-error';
          console.error("Detalhes do erro:", error);
        })
        .finally(() => {
          setTimeout(() => {
            submitButton.disabled = false;
          }, 4000);
        });
        // ========= FIN DE LA CORRECCI√ìN DEFINITIVA =========
      };
      reader.onerror = () => {
          statusMessage.textContent = 'Erro ao processar a imagem.';
          statusMessage.className = 'status-message status-error';
          submitButton.disabled = false;
      };
    });
  </script>
</body>
</html>
